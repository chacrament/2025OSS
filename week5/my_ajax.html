<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>22200100_김성찬_my_ajax.html</title>
  <style>
    :root { --gap: 10px; }
    body { font-family: system-ui, sans-serif; max-width: 980px; margin: 32px auto; padding: 0 12px; }
    h1 { margin: 0 0 6px; }
    .muted { color:#666; font-size: 0.92rem; margin: 4px 0 18px; }
    form { display: grid; grid-template-columns: repeat(6, 1fr) auto; gap: var(--gap); align-items: center; }
    input, select, button { padding: 10px; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    thead th { background:#fafafa; }
    tr:nth-child(even){ background:#fcfcfc; }
    .row { display: flex; gap: var(--gap); align-items: center; margin: 14px 0; }
    .row > * { flex: 0 0 auto; }
    .row input[type="search"] { flex: 1 1 auto; }
    .danger { background:#b00020; color:white; border:none; }
    .secondary { background:#f3f3f3; border:1px solid #ddd; }
  </style>
</head>
<body>
  <h1>JS AJAX CRUD</h1>
  <p class="muted">API: <code>http://localhost:3000/courses</code></p>

  <h2>새 과목 추가 / 수정</h2>
  <form id="courseForm" autocomplete="off">
    <input type="hidden" id="id" />
    <input id="code" placeholder="code (예: CSEE101)" required />
    <input id="title" placeholder="title (예: Intro to C++)" required />
    <input id="instructor" placeholder="instructor (예: Kim)" required />
    <input id="credits" type="number" min="1" max="5" placeholder="credits" required />
    <select id="level" required>
      <option value="">level</option>
      <option>Beginner</option>
      <option>Intermediate</option>
      <option>Advanced</option>
    </select>
    <button type="submit">저장</button>
  </form>

  <h2>과목 목록</h2>
  <table>
    <thead>
      <tr>
        <th style="width:70px">ID</th>
        <th>Code</th>
        <th>Title</th>
        <th>Instructor</th>
        <th style="width:90px">Credits</th>
        <th style="width:130px">Level</th>
        <th style="width:160px">Actions</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    const API_BASE = 'http://localhost:3000/courses';
    const $ = (id) => document.getElementById(id);
    const tbody = $('tbody');
    const form  = $('courseForm');

    async function req(url, options) {
      try {
        const res = await fetch(url, { cache: 'no-store', ...options });
        if (!res.ok) {
          const text = await res.text().catch(() => '');
          console.error('REQ ERROR', url, res.status, res.statusText, text);
          alert(`요청 실패: ${url}\n${res.status} ${res.statusText}\n${text.slice(0,200)}`);
          throw new Error(`${res.status} ${res.statusText}`);
        }
        return res;
      } catch (e) {
        console.error('FETCH FAIL', url, e);
        alert(`네트워크/브라우저 에러: ${e.message}`);
        throw e;
      }
    }

    async function list() {
      const res = await req(API_BASE);
      const rows = await res.json();

      rows.sort((a,b) => {
        const ai = Number(a.id); const bi = Number(b.id);
        const an = Number.isFinite(ai) ? ai : Number.POSITIVE_INFINITY;
        const bn = Number.isFinite(bi) ? bi : Number.POSITIVE_INFINITY;
        return an - bn;
      });

      tbody.innerHTML = rows.map(row => `
        <tr>
          <td>${row.id}</td>
          <td>${escapeHtml(row.code)}</td>
          <td>${escapeHtml(row.title)}</td>
          <td>${escapeHtml(row.instructor)}</td>
          <td>${row.credits}</td>
          <td>${escapeHtml(row.level)}</td>
          <td>
            <button onclick='edit(${JSON.stringify(row.id)})'>수정</button>
            <button class="danger" onclick='removeItem(${JSON.stringify(row.id)})'>삭제</button>
          </td>
        </tr>
      `).join('');
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    async function edit(id) {
      const res = await req(`${API_BASE}/${encodeURIComponent(id)}`);
      const row = await res.json();
      $('id').value = row.id;
      $('code').value = row.code ?? '';
      $('title').value = row.title ?? '';
      $('instructor').value = row.instructor ?? '';
      $('credits').value = row.credits ?? '';
      $('level').value = row.level ?? '';
      $('code').focus();
    }

    async function removeItem(id) {
      if (!confirm('정말 삭제할까요?')) return;
      await req(`${API_BASE}/${encodeURIComponent(id)}`, { method: 'DELETE' });
      await list();
    }

    function clearForm() {
      form.reset();
      $('id').value = '';
      $('code').focus();
    }

    function calcNextId(rows) {
      const numeric = rows
        .map(d => Number(d.id))
        .filter(n => Number.isFinite(n));
      return (numeric.length ? Math.max(...numeric) : 0) + 1;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        code: $('code').value.trim(),
        title: $('title').value.trim(),
        instructor: $('instructor').value.trim(),
        credits: Number($('credits').value),
        level: $('level').value
      };
      if (!payload.code || !payload.title || !payload.instructor || !payload.credits || !payload.level) {
        alert('모든 항목을 입력해 주세요.');
        return;
      }

      const id = $('id').value;

      if (id) {
        await req(`${API_BASE}/${encodeURIComponent(id)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: id, ...payload })
        });
      } else {
        const ID_OK = /^[0-9]+$/;
        const toId = (n) => String(n);
        function calcNextIdString(rows) {
          const nums = rows
            .map(r => parseInt(String(r.id).trim(), 10))
            .filter(n => Number.isFinite(n));
          const nextNum = (nums.length ? Math.max(...nums) : 0) + 1;
          return toId(nextNum);
        }

        const res = await req(API_BASE);
        const data = await res.json();
        const nextId = calcNextIdString(data);

        if (!ID_OK.test(nextId)) { alert('ID 생성 오류'); throw new Error('bad id'); }

        await req(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: nextId, ...payload })
        });
      }

      clearForm();
      await list();
    });

    list();

    window.edit = edit;
    window.removeItem = removeItem;
  </script>
</body>
</html>
